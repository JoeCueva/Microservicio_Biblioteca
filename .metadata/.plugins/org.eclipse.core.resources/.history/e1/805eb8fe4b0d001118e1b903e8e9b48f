package com.cibertec.controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.cibertec.biblioteca_Entity.Trabajadores;
import com.cibertec.dto.RolDto;
import com.cibertec.dto.TrabajadoresResponse;
import com.cibertec.repository.ITrabajadoresRepository;
import com.cibertec.security.JwtUtil;
import com.cibertec.service.RolServices;
import com.cibertec.service.TrabajadoresService;

@RestController
@RequestMapping("/api/v1/trabajadores-service-ws")
@CrossOrigin(origins = "http://localhost:4200")
public class TrabajadoresController {

	@Autowired
	private TrabajadoresService trabajadoresService;

	@Autowired
	private RolServices rolService;

	@Autowired
	private ITrabajadoresRepository trabajadorRepository;

	@Autowired
	private JwtUtil jwtUtil;

	// Listar todos
	@GetMapping
	public List<TrabajadoresResponse> listar() {
		return trabajadoresService.listarTrabajadores();
	}

	// Buscar por ID
	@GetMapping("/{id}")
	public TrabajadoresResponse buscarPorId(@PathVariable Integer id) {
		return trabajadoresService.buscarPorId(id);
	}

	// ✅ OBTENER USUARIO LOGUEADO
	@GetMapping("/me")
	public ResponseEntity<?> obtenerUsuarioLogueado(@RequestHeader("Authorization") String authHeader) {
		if (authHeader == null || !authHeader.startsWith("Bearer ")) {
			return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Token no proporcionado");
		}

		String token = authHeader.substring(7);

		try {
			String email = jwtUtil.obtenerUsername(token);

			Trabajadores usuario = trabajadorRepository.findByEmail(email)
					.orElseThrow(() -> new RuntimeException("Usuario no encontrado"));

			return ResponseEntity.ok(usuario);
		} catch (Exception e) {
			return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Token inválido o expirado: " + e.getMessage());
		}
	}

	// ✅ CREAR BIBLIOTECARIO (requiere autenticación)
	@PostMapping("/crear-bibliotecario")
	public ResponseEntity<?> crearBibliotecario(@RequestBody Trabajadores bibliotecario) {
		try {
			trabajadoresService.crearPorRol(bibliotecario, "Bibliotecario");
			return ResponseEntity.ok("Bibliotecario creado exitosamente");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		}
	}

	// ✅ CREAR AUXILIAR (requiere autenticación)
	@PostMapping("/crear-auxiliar")
	public ResponseEntity<?> crearAuxiliar(@RequestBody Trabajadores auxiliar) {
		try {
			trabajadoresService.crearPorRol(auxiliar, "Auxiliar de Biblioteca");
			return ResponseEntity.ok("Auxiliar de biblioteca creado exitosamente");
		} catch (RuntimeException e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		}
	}

	// Editar trabajador
	@PutMapping("/{id}")
	public ResponseEntity<?> editar(@PathVariable Integer id, @RequestBody Trabajadores datos) {
		try {
			TrabajadoresResponse actualizar = trabajadoresService.editarTrabajador(id, datos);
			return ResponseEntity.ok(actualizar);
		} catch (Exception e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		}
	}

	// Cambiar contraseña
	@PostMapping("/cambiar-password/{id}")
	public ResponseEntity<?> cambiarPassword(@PathVariable Integer id, @RequestBody Map<String, String> body) {
		try {
			String nueva = body.get("password");
			trabajadoresService.cambiarPassword(id, nueva);
			return ResponseEntity.ok("Contraseña actualizada");
		} catch (Exception e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		}
	}

	// Eliminar trabajador
	@DeleteMapping("/{id}")
	public ResponseEntity<?> eliminar(@PathVariable Integer id) {
		try {
			trabajadoresService.eliminarTrabajador(id);
			return ResponseEntity.ok("Trabajador eliminado correctamente");
		} catch (Exception e) {
			return ResponseEntity.badRequest().body(e.getMessage());
		}
	}

	// Listar roles
	@GetMapping("/roles")
	public List<Rol> listarRoles() {
		return rolService.listarRoles();
	}

	// Buscar rol por ID
	@GetMapping("/roles/{id}")
	public RolDto buscarRol(@PathVariable Integer id) {
		return rolService.buscarRolPorId(id);
	}

	// Conteo para dashboard
	@GetMapping("/conteo")
	public ResponseEntity<Map<String, Long>> conteo() {
		Map<String, Long> conteo = new HashMap<>();
		conteo.put("bibliotecarios", trabajadoresService.contarBibliotecarios());
		conteo.put("auxiliares", trabajadoresService.contarAuxiliares());
		return ResponseEntity.ok(conteo);
	}
}