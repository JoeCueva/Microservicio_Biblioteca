package com.cibertec.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.cibertec.biblioteca_Entity.EstadoLibro;
import com.cibertec.biblioteca_Entity.Prestamos;
import com.cibertec.client.LibroClient;
import com.cibertec.client.UsuarioClient;
import com.cibertec.dto.EstadoPrestamoDto;
import com.cibertec.dto.LibroDto;
import com.cibertec.dto.PrestamoDto;
import com.cibertec.dto.PrestamoRequest;
import com.cibertec.dto.PrestamoResponse;
import com.cibertec.dto.PrstamoDetalleCompletoDto;
import com.cibertec.dto.UsuarioDto;
import com.cibertec.mapper.PrestamoMapper;
import com.cibertec.repository.EstadoLibroRepository;
import com.cibertec.repository.PrestamoRepository;

import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;

@Service
public class PrestamoService {

	@Autowired
	private PrestamoRepository repository;

	@Autowired
	private EstadoLibroRepository estadoLibroRepository;

	@Autowired
	private UsuarioClient usuarioClient;

	@Autowired
	private LibroClient libroClient;

	@PersistenceContext
	private EntityManager entityManager;

	private PrestamoMapper mapper = new PrestamoMapper();

	public List<PrestamoResponse> getPrestamoslist() {
		return repository.findAll().stream().map(this::construirResponse).toList();
	}

	public PrestamoResponse getPrestamo(Integer id) {
		Prestamos prestamo = repository.findById(id)
				.orElseThrow(() -> new RuntimeException("El préstamo no existe con ID: " + id));
		return construirResponse(prestamo);
	}

	public List<PrestamoResponse> getPrestamoPorUsuario(Integer usuarioId) {
		return repository.findByUsuarioId(usuarioId).stream().map(this::construirResponse).toList();
	}

	public List<PrestamoDto> getPrestamoPorLibro(Integer libroId) {
		return repository.findByLibroId(libroId).stream().map(mapper::toDto).toList();
	}

	public PrestamoResponse crearPrestamo(PrestamoRequest request) {

		EstadoLibro estado = estadoLibroRepository.findById(request.getEstadoId())
				.orElseThrow(() -> new RuntimeException("Estado no encontrado con ID: " + request.getEstadoId()));

		Prestamos nuevo = mapper.toEntity(request);
		nuevo.setEstadoLibro(estado);

		Prestamos guardado = repository.saveAndFlush(nuevo);
		entityManager.clear();

		Prestamos prestamo = repository.findById(guardado.getId_prestamos())
				.orElseThrow(() -> new RuntimeException("Error al recuperar préstamo"));

		return construirResponse(prestamo);
	}

	public PrestamoResponse actualizarPrestamo(Integer id, PrestamoRequest request) {
		Prestamos existente = repository.findById(id)
				.orElseThrow(() -> new RuntimeException("El préstamo no existe con ID: " + id));

		if (request.getUsuarioId() != null) {
			existente.setUsuarioId(request.getUsuarioId());
		}
		if (request.getLibroId() != null) {
			existente.setLibroId(request.getLibroId());
		}
		if (request.getFechaPrestamo() != null) {
			existente.setFecha_prestamo(request.getFechaPrestamo());
		}
		if (request.getFechaDevolucion() != null) {
			existente.setFecha_devolucion(request.getFechaDevolucion());
		}
		if (request.getFechaReal() != null) {
			existente.setFecha_real(request.getFechaReal());
		}
		if (request.getComentarios() != null) {
			existente.setComentarios(request.getComentarios());
		}
		if (request.getEstadoId() != null) {
			EstadoLibro estado = estadoLibroRepository.findById(request.getEstadoId())
					.orElseThrow(() -> new RuntimeException("Estado no encontrado"));
			existente.setEstadoLibro(estado);
		}

		repository.saveAndFlush(existente);
		entityManager.clear();

		Prestamos actualizado = repository.findById(id)
				.orElseThrow(() -> new RuntimeException("Error al recuperar préstamo"));

		return construirResponse(actualizado);
	}

	public void eliminarPrestamo(Integer id) {
		if (!repository.existsById(id)) {
			throw new RuntimeException("El préstamo no existe con ID: " + id);
		}
		repository.deleteById(id);
	}

	public PrstamoDetalleCompletoDto getDetalleCompleto(Integer id) {
		Prestamos prestamo = repository.findById(id)
				.orElseThrow(() -> new RuntimeException("Préstamo no existe con ID: " + id));

		PrstamoDetalleCompletoDto detalle = new PrstamoDetalleCompletoDto();

		detalle.setPrestamoId(prestamo.getId_prestamos());
		detalle.setFechaPrestamo(prestamo.getFecha_prestamo());
		detalle.setFechaDevolucion(prestamo.getFecha_devolucion());
		detalle.setFechaReal(prestamo.getFecha_real());
		detalle.setMulta(prestamo.getMulta());
		detalle.setComentarios(prestamo.getComentarios());

		if (prestamo.getEstadoLibro() != null) {
			detalle.setEstadoPrestamo(prestamo.getEstadoLibro().getDescripcion());
		}

		try {
			UsuarioDto usuario = usuarioClient.getUsuario(prestamo.getUsuarioId());
			detalle.setUsuarioId(usuario.getUsuarioId());
			detalle.setNombreUsuario(usuario.getNombreUsuario());
			detalle.setApellidoUsuario(usuario.getApellidoUsuario());
			detalle.setDniUsuario(usuario.getDni());
			detalle.setCorreoUsuario(usuario.getCorreo());
			detalle.setTelefonoUsuario(usuario.getTelefono());
			detalle.setDireccionUsuario(usuario.getDireccion());
			detalle.setGeneroUsuario(usuario.getGenero());
			detalle.setFechaNacimientoUsuario(usuario.getFechaNacimiento());
		} catch (Exception e) {
			System.err.println("Error al obtener usuario: " + e.getMessage());
		}

		try {
			LibroDto libro = libroClient.getLibro(prestamo.getLibroId());
			detalle.setLibroId(libro.getId_libros());
			detalle.setTituloLibro(libro.getTitulo());
			detalle.setAnioLibro(libro.getAnio());
			detalle.setIsbnLibro(libro.getIsbn());
			detalle.setEditorialLibro(libro.getEditorial());
			detalle.setAutorLibro(libro.getNombreAutor());
			detalle.setNacionalidadAutor(libro.getNacionalidadAutor());
			detalle.setCategoriaLibro(libro.getNombreCategoria());
			detalle.setEstadoLibro(libro.getDescripcionEstado());
		} catch (Exception e) {
			System.err.println("Error al obtener libro: " + e.getMessage());
		}

		return detalle;
	}

	private PrestamoResponse construirResponse(Prestamos prestamo) {
		PrestamoResponse response = new PrestamoResponse();

		response.setPrestamoId(prestamo.getId_prestamos());
		response.setFechaPrestamo(prestamo.getFecha_prestamo());
		response.setFechaDevolucion(prestamo.getFecha_devolucion());
		response.setFechaReal(prestamo.getFecha_real());
		response.setMulta(prestamo.getMulta());
		response.setComentarios(prestamo.getComentarios());
		
		if (prestamo.getEstadoLibro() != null) {
			EstadoPrestamoDto estadoDto = new EstadoPrestamoDto();
			estadoDto.setIdEstado(prestamo.getEstadoLibro().getId_estado());
			estadoDto.setDescripcion(prestamo.getEstadoLibro().getDescripcion());
			response.setEstadoPrestamo(estadoDto);
		}

		try {
			UsuarioDto usuarioCompleto = usuarioClient.getUsuario(prestamo.getUsuarioId());

			UsuarioDto usuarioDto = new UsuarioDto();
			usuarioDto.setUsuarioId(usuarioCompleto.getUsuarioId());
			usuarioDto.setNombreUsuario(usuarioCompleto.getNombreUsuario());
			usuarioDto.setApellidoUsuario(usuarioCompleto.getApellidoUsuario());
			usuarioDto.setCorreo(usuarioCompleto.getCorreo());
			usuarioDto.setTelefono(usuarioCompleto.getTelefono());

			response.setUsuario(usuarioDto);
		} catch (Exception e) {
			System.err.println("Error al obtener usuario: " + e.getMessage());
		}

		try {
			LibroDto libroCompleto = libroClient.getLibro(prestamo.getLibroId());

			LibroDto libroDto = new LibroDto();
			libroDto.setId_libros(libroCompleto.getId_libros());
			libroDto.setTitulo(libroCompleto.getTitulo());
			libroDto.setIsbn(libroCompleto.getIsbn());
			libroDto.setEditorial(libroCompleto.getEditorial());
			libroDto.setIdAutor(libroCompleto.getIdAutor());
			libroDto.setIdCategoria(libroCompleto.getIdCategoria());
			libroDto.setIdEstado(libroCompleto.getIdEstado());

			response.setLibro(libroDto);
		} catch (Exception e) {
			System.err.println("Error al obtener libro: " + e.getMessage());
		}

		return response;
	}
}
