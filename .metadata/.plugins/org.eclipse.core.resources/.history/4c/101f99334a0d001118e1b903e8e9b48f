package com.cibertec.service;

import java.util.List;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.cibertec.biblioteca_Entity.Rol;
import com.cibertec.biblioteca_Entity.Trabajadores;
import com.cibertec.dto.TrabajadoresResponse;
import com.cibertec.mapper.TrabajadoresMapper;
import com.cibertec.repository.IRolRepository;
import com.cibertec.repository.ITrabajadoresRepository;

@Service
public class TrabajadoresService {

    @Autowired
    private ITrabajadoresRepository trabajadoresRepository;

    @Autowired
    private IRolRepository rolRepository;

    private TrabajadoresMapper mapper = new TrabajadoresMapper();

    // Listar todos
    public List<TrabajadoresResponse> listarTrabajadores() {
        return trabajadoresRepository.findAll()
            .stream()
            .map(mapper::toResponse)
            .toList();
    }

    
    public TrabajadoresResponse buscarPorId(Integer id) {
        Trabajadores trabajador = trabajadoresRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Trabajador no encontrado con ID: " + id));
        return mapper.toResponse(trabajador);
    }


    public TrabajadoresResponse crearAdministrador(Trabajadores trabajadores) {
     
        if (trabajadoresRepository.contarPorRol(1) > 0) {
            throw new RuntimeException("Ya existe un Administrador registrado. No se puede crear otro.");
        }

        
        if (trabajadoresRepository.existsByEmail(trabajadores.getEmail())) {
            throw new RuntimeException("El email " + trabajadores.getEmail() + " ya está registrado");
        }

     
        Rol rolAdmin = rolRepository.findById(1)
            .orElseThrow(() -> new RuntimeException("Rol Administrador no existe en la BD"));
        
        trabajadores.setRol(rolAdmin);

        return mapper.toResponse(trabajadoresRepository.save(trabajadores));
    }

    public TrabajadoresResponse crearBibliotecario(Trabajadores trabajadores) {
        
        if (trabajadoresRepository.existsByEmail(trabajadores.getEmail())) {
            throw new RuntimeException("El email " + trabajadores.getEmail() + " ya está registrado");
        }

        Rol rolBibliotecario = rolRepository.findById(3)
            .orElseThrow(() -> new RuntimeException("Rol Bibliotecario no existe en la BD"));
        
        trabajadores.setRol(rolBibliotecario);

        return mapper.toResponse(trabajadoresRepository.save(trabajadores));
    }

    public TrabajadoresResponse editarTrabajador(Integer id, Trabajadores trabajadores) {
        Trabajadores existente = trabajadoresRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Trabajador no encontrado con ID: " + id));

        if (!existente.getEmail().equals(trabajadores.getEmail()) &&
            trabajadoresRepository.existsByEmail(trabajadores.getEmail())) {
            throw new RuntimeException("El email " + trabajadores.getEmail() + " ya está registrado");
        }

        existente.setNombre(trabajadores.getNombre());
        existente.setApellido(trabajadores.getApellido());
        existente.setEmail(trabajadores.getEmail());
        existente.setEdad(trabajadores.getEdad());
        existente.setPassword(trabajadores.getPassword());

        return mapper.toResponse(trabajadoresRepository.save(existente));
    }

    public void eliminarTrabajador(Integer id) {
        if (!trabajadoresRepository.existsById(id)) {
            throw new RuntimeException("Trabajador no encontrado con ID: " + id);
        }
        trabajadoresRepository.deleteById(id);
    }

    public Long contarBibliotecarios() {
        return trabajadoresRepository.contarPorRol(3);
    }

    public Long contarAuxiliares() {
        return trabajadoresRepository.contarPorRol(2);
    }
}